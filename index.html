<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ªãch Thu·∫≠t Ti·ªÉu La - Th·∫ßy Nghƒ©a</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #eceff1; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .app-card { width: 100%; max-width: 500px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 20px; }
        #display { height: 350px; overflow-y: auto; border: 1px solid #eee; padding: 15px; margin: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        .bubble { padding: 10px 15px; border-radius: 15px; max-width: 85%; font-size: 16px; line-height: 1.4; }
        .vi { align-self: flex-start; background: #d1eaff; color: #0277bd; }
        .foreign { align-self: flex-end; background: #e8f5e9; color: #2e7d32; text-align: right; }
        #micBtn { width: 100%; padding: 20px; border: none; border-radius: 50px; background: #007bff; color: white; font-size: 18px; font-weight: bold; cursor: pointer; }
        #micBtn.active { background: #f44336; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        #status { font-size: 14px; color: #757575; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="app-card">
        <h3 style="text-align: center; margin-top: 0;">üåê Phi√™n d·ªãch ƒëa ng·ªØ</h3>
        <div id="display"></div>
        <button id="micBtn">üé§ B·∫§M ƒê·ªÇ N√ìI</button>
        <div id="status">Ch∆∞a b·∫Øt ƒë·∫ßu</div>
    </div>

    <script>
        const micBtn = document.getElementById('micBtn');
        const display = document.getElementById('display');
        const status = document.getElementById('status');
        let guestLang = null;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ gi·ªçng n√≥i. Th·∫ßy h√£y d√πng Chrome nh√©!");
        }
        const recognition = new SpeechRecognition();
        recognition.lang = 'vi-VN'; 
        recognition.interimResults = false;

        micBtn.onclick = () => {
            try {
                recognition.start();
            } catch (e) {
                console.log("ƒê√£ ƒëang nghe r·ªìi...");
            }
        };

        recognition.onstart = () => {
            micBtn.innerText = "ƒêANG NGHE...";
            micBtn.classList.add('active');
            status.innerText = "Th·∫ßy ho·∫∑c kh√°ch h√£y n√≥i v√†o micro...";
        };

        recognition.onresult = async (event) => {
            const speechText = event.results[0][0].transcript;
            status.innerText = "ƒêang d·ªãch...";
            
            // T·ª± ƒë·ªông nh·∫≠n di·ªán v√† d·ªãch
            const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=vi&dt=t&q=${encodeURI(speechText)}`);
            const data = await res.json();
            const detected = data[2];
            const translatedVi = data[0][0][0];

            if (detected === 'vi') {
                // Th·∫ßy n√≥i ti·∫øng Vi·ªát
                const target = guestLang || 'en';
                const resF = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=vi&tl=${target}&dt=t&q=${encodeURI(speechText)}`);
                const dataF = await resF.json();
                addBubble(speechText, dataF[0][0][0], 'vi');
            } else {
                // Kh√°ch n√≥i ti·∫øng n∆∞·ªõc ngo√†i
                guestLang = detected;
                addBubble(speechText, translatedVi, 'foreign');
            }
        };

        recognition.onerror = (e) => {
            status.innerText = "L·ªói: " + e.error;
            stopMic();
        };

        recognition.onend = () => stopMic();

        function stopMic() {
            micBtn.innerText = "üé§ B·∫§M ƒê·ªÇ N√ìI";
            micBtn.classList.remove('active');
        }

        function addBubble(orig, trans, type) {
            const div = document.createElement('div');
            div.className = `bubble ${type}`;
            div.innerHTML = `<strong>${orig}</strong><br><em>${trans}</em>`;
            display.appendChild(div);
            display.scrollTop = display.scrollHeight;
            status.innerText = "ƒê√£ xong.";

            // ƒê·ªçc c√¢u d·ªãch
            const msg = new SpeechSynthesisUtterance(trans);
            msg.lang = (type === 'vi') ? (guestLang || 'en') : 'vi';
            window.speechSynthesis.speak(msg);
        }
    </script>
</body>
</html>